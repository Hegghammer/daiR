<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating searchable PDFs • daiR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Creating searchable PDFs">
<meta property="og:description" content="daiR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-KFVWN0R920"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KFVWN0R920');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">daiR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/quickstart.html">Quickstart</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/configuration.html">Configuration</a>
    </li>
    <li>
      <a href="../articles/gcs_storage.html">Working with Google Cloud Storage</a>
    </li>
    <li>
      <a href="../articles/usage.html">Basic usage</a>
    </li>
    <li>
      <a href="../articles/tables.html">Extracting tables</a>
    </li>
    <li>
      <a href="../articles/reconstructing_text.html">Correcting text output</a>
    </li>
    <li>
      <a href="../articles/searchable_pdfs.html">Creating searchable PDFs</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/faqs.html">FAQs</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="https://github.com/hegghammer/dair/" class="external-link">
    <span class="fab fa-github"></span>
     
    Github
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Hegghammer/daiR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Creating searchable PDFs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Hegghammer/daiR/blob/HEAD/vignettes/articles/searchable_pdfs.Rmd" class="external-link"><code>vignettes/articles/searchable_pdfs.Rmd</code></a></small>
      <div class="hidden name"><code>searchable_pdfs.Rmd</code></div>

    </div>

    
    
<p>Somewhat surprisingly, the Google Document AI tool suite does not
include a straightforward way to embed OCR output in PDFs. This
functionality exists in many other OCR products – in Tesseract, for
example, it’s as simple as
running(<code>tesseract input.jpg output pdf</code>) – so I suspect
Google just hasn’t prioritized it. Interestingly, the Python client
library “Document AI Toolbox” includes a <a href="https://cloud.google.com/document-ai/docs/toolbox#hocr-conversion" class="external-link">hOCR
conversion script</a>) but stops short of providing a method for
creating searchable PDFs.</p>
<p>This said, writing code to reliably create searchable PDFs from
custom OCR output is not straightforward, especially outside of Python.
The main challenge is embedding text in PDFs in the right places,
handling font sizes and encoding issues along the way. As far as I am
aware, the only open-source tool that can do it well is the <a href="https://docs.reportlab.com/" class="external-link">Reportlab PDF Toolkit</a> (a Python
library). But the Reportlab toolkit itself does not include a direct
solution for converting OCR output formats such as HOCR and ALTO to
searchable PDFs, so it is left to small community efforts such as <a href="https://github.com/ocropus/hocr-tools" class="external-link">hocr-tools</a> to implement
it (by adapting Reportlab’s code). Meanwhile, in R, there are no
packages that can embed text in PDFs, let alone create searchable PDFs
from custom OCR output.</p>
<p>This is why <code>daiR</code> does not provide a native R solution
for embedding OCR-extracted text in PDFs. However, as of version 0.9.9,
<code>daiR</code> includes the function <code>make_hocr</code>, which
creates HOCR files from Document AI output, and this takes us some of
the distance. This article will describe a simple pipeline which
combines <code>dair::make_hocr</code> and the command-line tool <a href="https://github.com/ocropus/hocr-tools#hocr-pdf" class="external-link">hocr-pdf</a> from
the aforementioned hocr-tools project.</p>
<p>Before we begin, you may want to install <code>hocr-tools</code> on
your computer. Instructions are <a href="https://github.com/ocropus/hocr-tools" class="external-link">here</a>. Note that the
package version on PyPI currently lags behind the Github codebase, and I
had to clone the repository and build from source to get the
<code>hocr-pdf</code> function to work. This situation will hopefully
change in due course.</p>
<p>Note that hocr-pdf only handles individual <code>.jpg</code> images,
and it works best if the hocr file is generated from an OCR process
involving the same <code>.jpg</code> file. This means you cannot process
a multi-page pdf in Document AI and take the output to hocr-pdf; you
need to convert the pdf to a set of <code>.jpg</code> files first and
then feed them individually to Document AI, so that you get hocr files
that match the <code>.jpg</code> files. Other than this quirk, the
procedure works well.</p>
<p>In this illustration, we will use a single, “ready made”
<code>.jpg</code>. Conversion from PDF to <code>.jpg</code> can be done
quite easily with packages like <code>pdftools</code> or
<code>magick</code>.</p>
<p><img src="sample.jpg" width="50%"></p>
<p>Let us start by downloading the image into a temporary subdirectory
of our working directory.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"temp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://dair.info/articles/sample.jpg"</span>, <span class="st">"temp/sample.jpg"</span><span class="op">)</span></span></code></pre></div>
<p>Then we process the image synchronously with Document AI.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Hegghammer/daiR" class="external-link">daiR</a></span><span class="op">)</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dai_sync.html">dai_sync</a></span><span class="op">(</span><span class="st">"temp/sample.jpg"</span><span class="op">)</span></span></code></pre></div>
<p>Then we generate the HOCR file:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/make_hocr.html">make_hocr</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"sync"</span>, output <span class="op">=</span> <span class="va">resp</span>, dir <span class="op">=</span> <span class="st">"temp"</span>, outfile_name <span class="op">=</span> <span class="st">"sample.hocr"</span><span class="op">)</span></span></code></pre></div>
<p>Note that the two files <code>sample.jpg</code> and
<code>sample.hocr</code> carry the same name (<code>sample</code>) and
reside in the same directory (<code>temp</code>). Both conditions are
necessary for <code>hocr-pdf</code> to work.</p>
<p>If <code>hocr-tools</code> is installed, we can now run the
<code>hocr-pdf</code> utility, either in the terminal or from within R
using the <code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code> command.</p>
<p>In the terminal:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">hocr-pdf</span> temp <span class="op">&gt;</span> temp/sample.pdf</span></code></pre></div>
<p>In R:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"hocr-pdf temp &gt; temp/sample.pdf"</span><span class="op">)</span></span></code></pre></div>
<p>And you should now have a searchable PDF in the <code>temp</code>
directory.</p>
<p><img src="sample_searchable.png" width="50%"></p>
<p>Note that you can also open the <code>.hocr</code> file in a web
browser and read the extracted text there. Just right-click on it in the
file explorer, click “open with”, and select your browser. This works
for <code>.hocr</code> files generated from documents in all the
languages that DAI covers.</p>
<div class="section level3">
<h3 id="note-on-encoding">Note on encoding<a class="anchor" aria-label="anchor" href="#note-on-encoding"></a>
</h3>
<p><code>make_hocr</code> handles non-Latin scripts and right-to-left
languages just fine, but unfortunately <code>hocr-pdf</code> cannot as
yet embed non-Latin script in pdfs. This means there is currently no way
of creating searchable pdfs from documents with such scripts OCRed in
Document AI – at least to my knowledge. To generate searchable pdfs from
such documents, you can use Tesseract, but then you get the output from
a different OCR engine.</p>
<p>Languages tested:</p>
<ul>
<li>English: <code><a href="../reference/make_hocr.html">make_hocr()</a></code> and <code>hocr-pdf</code> both
work.</li>
<li>Arabic: <code><a href="../reference/make_hocr.html">make_hocr()</a></code> works, but <code>hocr-pdf</code>
does not.</li>
<li>Chinese: <code><a href="../reference/make_hocr.html">make_hocr()</a></code> works, but <code>hocr-pdf</code>
does not.</li>
<li>Japanese: <code><a href="../reference/make_hocr.html">make_hocr()</a></code> works, but <code>hocr-pdf</code>
does not.</li>
<li>Russian: <code><a href="../reference/make_hocr.html">make_hocr()</a></code> works, but <code>hocr-pdf</code>
does not.</li>
</ul>
</div>
<div class="section level3">
<h3 id="cleanup">Cleanup<a class="anchor" aria-label="anchor" href="#cleanup"></a>
</h3>
<p>To remove the directory with the example files:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"temp"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Thomas Hegghammer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
