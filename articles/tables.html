<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extracting tables • daiR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Extracting tables">
<meta property="og:description" content="daiR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-NL6TR4PT51"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NL6TR4PT51');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">daiR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/quickstart.html">Quickstart</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/configuration.html">Configuration</a>
    </li>
    <li>
      <a href="../articles/gcs_storage.html">Working with Google Cloud Storage</a>
    </li>
    <li>
      <a href="../articles/usage.html">Basic usage</a>
    </li>
    <li>
      <a href="../articles/tables.html">Extracting tables</a>
    </li>
    <li>
      <a href="../articles/reconstructing_text.html">Correcting text output</a>
    </li>
    <li>
      <a href="../articles/searchable_pdfs.html">Creating searchable PDFs</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/faqs.html">FAQs</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="https://github.com/hegghammer/dair/" class="external-link">
    <span class="fab fa-github"></span>
     
    Github
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Hegghammer/daiR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extracting tables</h1>
                        <h4 data-toc-skip class="author">Thomas
Hegghammer</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Hegghammer/daiR/blob/HEAD/vignettes/tables.Rmd" class="external-link"><code>vignettes/tables.Rmd</code></a></small>
      <div class="hidden name"><code>tables.Rmd</code></div>

    </div>

    
    
<p><strong>Last updated 10 February 2024</strong><br><br><br></p>
<p>In many OCR scenarios, we’re interested in extracting tabular data
from an image scan. Regular OCR often fails at this task, returning the
content of the table simply as lines with numbers instead of as
structured data. But the Google Document AI ecosystem has specialised
processors with powerful form parsing and table extraction capabilities,
most of which can be leveraged in R with <code>daiR</code>.</p>
<p>To extract table data from a PDF or an image, we use the core
functions <code><a href="../reference/dai_sync.html">dai_sync()</a></code> and <code>dai_async</code> as we would
with text (see the vignette on <a href="(https://dair.info/articles/usage.html)" class="external-link">basic use</a>), except we
need to use a processor of type <code>FORM_PARSER_PROCESSOR</code>
instead of the default type <code>OCR_PROCESSOR</code>.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> We then use the
function <code><a href="../reference/get_tables.html">get_tables()</a></code> on the response object or JSON file,
in much the same way as we would with <code><a href="../reference/get_text.html">get_text()</a></code>.</p>
<div class="section level2">
<h2 id="activating-a-form-parser-processor">Activating a form parser processor<a class="anchor" aria-label="anchor" href="#activating-a-form-parser-processor"></a>
</h2>
<p>The first step toward extracting tables is to activate a processor of
type <code>FORM_PARSER_PROCESSOR</code>. Depending on your use history,
you may or may not have such a processor available already. You can
check with the following code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">processors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_processors.html">get_processors</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"FORM_PARSER"</span>, <span class="va">processors</span><span class="op">$</span><span class="va">type</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If this yields <code>TRUE</code>, you have one or more form parser
processors already. Assuming you only have one<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, you can store the id
in a variable like so:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formparser_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">processors</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">processors</span><span class="op">$</span><span class="va">type</span> <span class="op">==</span> <span class="st">"FORM_PARSER_PROCESSOR"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>If the earlier command yielded <code>FALSE</code>, you don’t have a
form parser processor, and you must create one. This is very easy to do.
Just run the following command, adding a unique name for your
processor.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formparser_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_processor.html">create_processor</a></span><span class="op">(</span><span class="st">"&lt;unique_chosen_name&gt;"</span>, type <span class="op">=</span> <span class="st">"FORM_PARSER_PROCESSOR"</span><span class="op">)</span></span></code></pre></div>
<p>If the processor name has been taken, you will get an error to this
effect. If so, just retry with another name. When successful,
<code><a href="../reference/create_processor.html">create_processor()</a></code> returns the id of the created processor,
and we can capture it in the variable <code>formparser_id</code>. Double
check that it worked by viewing its content:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formparser_id</span></span></code></pre></div>
<p>If still in doubt, run <code><a href="../reference/get_processors.html">get_processors()</a></code> again and
eyeball the output. The new form parser model should be there.</p>
</div>
<div class="section level2">
<h2 id="synchronous-processing-with-form-parsers">Synchronous processing with form parsers<a class="anchor" aria-label="anchor" href="#synchronous-processing-with-form-parsers"></a>
</h2>
<p>Now that you have the id of an active form parser processor stored in
the variable <code>formparser_id</code>, you are ready to process
documents with it.</p>
<p>Let us test it on a pdf from the so-called <a href="https://en.wikipedia.org/wiki/Truth_Tobacco_Industry_Documents" class="external-link">Truth
Tobacco Industry Documents</a>, which contains four tables like
this:</p>
<p><img src="tobacco.PNG" width="100%"></p>
<p>First we download it:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://archive.org/download/tobacco_lpnn0000/lpnn0000.pdf"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="st">"tobacco.pdf"</span><span class="op">)</span></span></code></pre></div>
<p>All you now need to do is to run a regular <code><a href="../reference/dai_sync.html">dai_sync()</a></code>
command, supplying the id of your form parser processor in the
<code>proc_id</code> parameter. Since it’s a four-page document, it may
take 20-30 seconds to process.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dai_sync.html">dai_sync</a></span><span class="op">(</span><span class="st">"tobacco.pdf"</span>, proc_id <span class="op">=</span> <span class="va">formparser_id</span><span class="op">)</span></span></code></pre></div>
<p>We can then pass the response object to <code><a href="../reference/get_tables.html">get_tables()</a></code>,
which will return a list with all the tables it found.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tables.html">get_tables</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span></code></pre></div>
<p>Running <code>length(tables)</code> suggests the list contains four
tables, which corresponds to the number of pages in the PDF. We can
inspect them individually like this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/View.html" class="external-link">View</a></span><span class="op">(</span><span class="va">tables</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Or we can import them all into our global environment with
<code><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign()</a></code>, as follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">tables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"table"</span>, <span class="va">i</span><span class="op">)</span>, <span class="va">tables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Or we can save them all to <code>.csv</code> files like so:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">tables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"table"</span>, <span class="va">i</span>, <span class="st">".csv"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">tables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">filename</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Either way, the result is pretty good. Here’s what the first table
looks like in my RStudio before any cleaning:</p>
<p><img src="table.PNG" width="100%"></p>
</div>
<div class="section level2">
<h2 id="asynchronous-processing-with-form-parsers">Asynchronous processing with form parsers<a class="anchor" aria-label="anchor" href="#asynchronous-processing-with-form-parsers"></a>
</h2>
<p>Asynchronous processing is very similar. First we upload the file to
a storage bucket:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/" class="external-link">googleCloudStorageR</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html" class="external-link">gcs_upload</a></span><span class="op">(</span><span class="st">"tobacco.pdf"</span><span class="op">)</span></span></code></pre></div>
<p>Then we check that it arrived.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_list_objects.html" class="external-link">gcs_list_objects</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Then we pass the filename to <code>dai_async</code>, specifying that
we want the form parser processor to be applied. We also run
<code><a href="../reference/dai_notify.html">dai_notify()</a></code> so we get a beep when the JSON file is ready
(it should take about 30 seconds).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dai_async.html">dai_async</a></span><span class="op">(</span><span class="st">"tobacco.pdf"</span>, proc_id <span class="op">=</span> <span class="va">formparser_id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dai_notify.html">dai_notify</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span></code></pre></div>
<p>Then we download the JSON file. There probably aren’t many other JSON
files containing the word “tobacco” in the bucket , so a quick Regex
should find it.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contents</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_list_objects.html" class="external-link">gcs_list_objects</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">our_json</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"tobacco.*json"</span>, <span class="va">contents</span><span class="op">$</span><span class="va">name</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_get_object.html" class="external-link">gcs_get_object</a></span><span class="op">(</span><span class="va">our_json</span>, saveToDisk <span class="op">=</span> <span class="st">"tobacco.json"</span><span class="op">)</span></span></code></pre></div>
<p>Finally we supply the file to <code><a href="../reference/get_tables.html">get_tables()</a></code>, just making
sure to add <code>type = "async"</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tables.html">get_tables</a></span><span class="op">(</span><span class="st">"tobacco.json"</span>, type <span class="op">=</span> <span class="st">"async"</span><span class="op">)</span></span></code></pre></div>
<p>That’s all there is to it.</p>
</div>
<div class="section level2">
<h2 id="how-good-is-it">How good is it?<a class="anchor" aria-label="anchor" href="#how-good-is-it"></a>
</h2>
<p>Most of the time you should get pretty good results. Don’t expect
perfection, but do expect something that you can quickly clean up
manually in Excel. However, the quality of the output varies, depending
on a variety of factors, including</p>
<ul>
<li>the language (it works best on English)</li>
<li>the complexity of the table (row and column spans are
challenging)</li>
<li>the amount of visual noise in the original document</li>
<li>the resolution of the image passed to Document AI.</li>
</ul>
<p>For optimal results, use a high-resolution scan, crop the image to
remove everything except the table, and process asynchronously.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>This way of getting tables was introduced in early 2024.
Before then, the process involved calling another API endpoint
(<code>v1beta2</code>), which is why <code>daiR</code> used to have a
separate set of functions to deal with tables. On 31 January 2024,
Google discontinued the <code>v1beta2</code> endpoint, making these
functions obsolete. As a result, <code><a href="../reference/defunct.html">dai_sync_tab()</a></code> and
<code><a href="../reference/defunct.html">dai_async_tab()</a></code> have been made defunct, while
<code><a href="../reference/tables_from_dai_response.html">tables_from_dai_response()</a></code> and
<code><a href="../reference/tables_from_dai_file.html">tables_from_dai_file()</a></code> have been deprecated.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>If you have more than one form parser processor,
<code>formparser_id</code> will contain more than one id. If so, either
pick the first and best by running
<code>formparser_id &lt;- formparser_id[1]</code> or choose a specific
one manually and assign it to the variable <code>formparser_id</code>.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Thomas Hegghammer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
