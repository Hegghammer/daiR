<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Correcting text output from Google Document AI • daiR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Correcting text output from Google Document AI">
<meta property="og:description" content="daiR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-NL6TR4PT51"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NL6TR4PT51');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">daiR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/basics.html">Quickstart</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setting_up_google_storage.html">Setting up a Google Storage Bucket</a>
    </li>
    <li>
      <a href="../articles/using_document_ai.html">Using Google Document AI with R</a>
    </li>
    <li>
      <a href="../articles/reconstructing_text.html">Correcting text output from Google Document AI</a>
    </li>
    <li>
      <a href="../articles/Complex_file_and_folder_management.html">Complex file and folder management</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="https://github.com/hegghammer/dair/">
    <span class="fab fa-github"></span>
     
    Github
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Hegghammer/daiR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="reconstructing_text_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Correcting text output from Google Document AI</h1>
                        <h4 class="author">Thomas Hegghammer</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Hegghammer/daiR/blob/master/vignettes/reconstructing_text.Rmd"><code>vignettes/reconstructing_text.Rmd</code></a></small>
      <div class="hidden name"><code>reconstructing_text.Rmd</code></div>

    </div>

    
    
<p><strong>Last updated 4 March 2021</strong><br><br><br></p>
<p>Google Document AI (DAI) has excellent character recognition, but often reads columns wrong. This vignette will show you how to identify and reorder jumbled text with the tools in the <code>daiR</code> package.</p>
<div id="the-problem" class="section level2">
<h2 class="hasAnchor">
<a href="#the-problem" class="anchor"></a>The problem</h2>
<p>Server-based OCR engines such as Google Document AI and Amazon Textract represent a major advance in OCR technology. They handle visual noise extremely well and effectively eliminate the need for image preprocessing, the most agonizing part of OCR in <code>tesseract</code> and other standalone libraries. DAI also reads non-Western languages such as Arabic better than any other general engine I have seen.</p>
<p>But DAI and Textract still struggle with text columns and irregular page layouts. In my experience, DAI will misread a multi-column page about half the time, and the error rate increases with the complexity of the layout. This is not a problem if you plan to apply “bag-of-words” text mining techniques, but if you’re looking at Natural Language Processing or actually reading the text, you cannot trust Document AI or Textract to always return accurate text.</p>
<p>DAI column-reading errors are of two main types. The first is to put text blocks in the wrong order, and the second is to merge blocks that shouldn’t be merged. Both errors can be corrected programmatically with the tools in the <code>daiR</code> package.</p>
</div>
<div id="reordering-blocks" class="section level2">
<h2 class="hasAnchor">
<a href="#reordering-blocks" class="anchor"></a>Reordering blocks</h2>
<p>To illustrate, let’s feed DAI a simple two-column text. This one is from the CIA’s archive of declassified intelligence documents:</p>
<p><img src="CIA_columns.jpg" width="50%"></p>
<p>Following the two other <code>daiR</code> vignettes, we start by loading the libaries and setting our default Storage bucket:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Hegghammer/daiR">daiR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/">googleCloudStorageR</a></span><span class="op">)</span>

<span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_global_bucket.html">gcs_global_bucket</a></span><span class="op">(</span><span class="st">"superbucket_2021"</span><span class="op">)</span></code></pre></div>
<p>Then we get our pdf, upload it to Google Storage, and pass it to Document AI:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="st">"https://www.cia.gov/readingroom/docs/1968-03-08.pdf"</span>,
              <span class="st">"CIA_columns.pdf"</span>, 
              mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span>

<span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html">gcs_upload</a></span><span class="op">(</span><span class="st">"CIA_columns.pdf"</span><span class="op">)</span>

<span class="fu"><a href="../reference/dai_async.html">dai_async</a></span><span class="op">(</span><span class="st">"CIA_columns.pdf"</span><span class="op">)</span></code></pre></div>
<p>We check our bucket for the json output and download it when it’s ready:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_list_objects.html">gcs_list_objects</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_get_object.html">gcs_get_object</a></span><span class="op">(</span><span class="st">"CIA_columns.pdf-output-page-1-to-1.json"</span>, 
               saveToDisk <span class="op">=</span> <span class="st">"CIA_columns.json"</span><span class="op">)</span></code></pre></div>
<p>Finally we extract the text:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/text_from_dai_file.html">text_from_dai_file</a></span><span class="op">(</span><span class="st">"CIA_columns.json"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span>
<span class="co">#&gt; Approved For Release 2009/02/06: CIA-RDP79-00927A006300050002-8</span>
<span class="co">#&gt; SECRET</span>
<span class="co">#&gt; CZECHOSLOVAKIA OUTLINES ECONOMIC "ACTION PROGRAM”</span>
<span class="co">#&gt; The Dubcek regime has out-</span>
<span class="co">#&gt; lined the economic portion of</span>
<span class="co">#&gt; its party "action program.' It</span>
<span class="co">#&gt; calls for the end of fixed prices</span>
<span class="co">#&gt; on a large number of items, with</span>
<span class="co">#&gt; prices on others being permitted</span>
<span class="co">#&gt; to fluctuate within limits. Un-</span>
<span class="co">#&gt; less these changes are made with</span>
<span class="co">#&gt; a careful view to their impact</span>
<span class="co">#&gt; on living standards, however,</span>
<span class="co">#&gt; they might reduce public support</span>
<span class="co">#&gt; for the new Dubcek administra-</span>
<span class="co">#&gt; tion.</span>
<span class="co">#&gt; Czech consumer in connection</span>
<span class="co">#&gt; with these price increases. It</span>
<span class="co">#&gt; states that retail prices will</span>
<span class="co">#&gt; not be changed without considering</span>
<span class="co">#&gt; incomes of the population, and</span>
<span class="co">#&gt; that increases probably will be</span>
<span class="co">#&gt; reviewed by a special commission</span>
<span class="co">#&gt; on living standards to ensure</span>
<span class="co">#&gt; that the general level of retail</span>
<span class="co">#&gt; prices stays within present guide-</span>
<span class="co">#&gt; lines.</span>
<span class="co">#&gt; This suggests that the</span>
<span class="co">#&gt; regime is well aware of the po-</span>
<span class="co">#&gt; litical danger in a sharp drop</span>
<span class="co">#&gt; in living standards.</span>
<span class="co">#&gt; The Novotny regime had rec-</span>
<span class="co">#&gt; ognized that major changes in</span>
<span class="co">#&gt; the retail pricing system were</span>
<span class="co">#&gt; essential to a meaningful eco-</span>
<span class="co">#&gt; nomic reform program, but had</span>
<span class="co">#&gt; taken little action in this field.</span>
<span class="co">#&gt; Under the newly announced pro-</span>
<span class="co">#&gt; gram, subsidies to producers</span>
<span class="co">#&gt; will be reduced and the turn-</span>
<span class="co">#&gt; over tax on retail sales will</span>
<span class="co">#&gt; be made more flexible. These</span>
<span class="co">#&gt; measures are not controversial,</span>
<span class="co">#&gt; but their result will be an in-</span>
<span class="co">#&gt; crease in some retail prices.</span>
<span class="co">#&gt; Many of the other major rec-</span>
<span class="co">#&gt; ommendations of the economic "ac-</span>
<span class="co">#&gt; tion program" were drawn directly</span>
<span class="co">#&gt; from the economic reform begun</span>
<span class="co">#&gt; two years ago.</span>
<span class="co">#&gt; Plant managers</span>
<span class="co">#&gt; will have more freedom both in</span>
<span class="co">#&gt; staffing and in production de-</span>
<span class="co">#&gt; cisions, and will have greater</span>
<span class="co">#&gt; responsibility for profitable op-</span>
<span class="co">#&gt; eration. The program also con-</span>
<span class="co">#&gt; tains a new proposal</span>
<span class="co">#&gt; that mar-</span>
<span class="co">#&gt; ginal agricultural land be leased</span>
<span class="co">#&gt; to independent producers as a</span>
<span class="co">#&gt; means of stimulating production.</span>
<span class="co">#&gt; The economic "action pro-</span>
<span class="co">#&gt; gram" promises safeguards to the</span>
<span class="co">#&gt; 25X1</span>
<span class="co">#&gt; *</span>
<span class="co">#&gt; SECRET</span>
<span class="co">#&gt; Page</span>
<span class="co">#&gt; 12</span>
<span class="co">#&gt; WEEKLY SUMMARY</span>
<span class="co">#&gt; 8 Mar 68</span>
<span class="co">#&gt; Approved For Release 2009/02/06 : CIA-RDP79-00927A006300050002-8</span></code></pre></div>
<p>On first inspection, this does not look so bad. But notice the transition from the first to the second paragraph:</p>
<blockquote>
<p>… they might reduce public support for the new Dubcek administration. Czech consumer in connection with these price increases.</p>
</blockquote>
<p>Something’s not right. Could it be a column-reading error?</p>
<p>We can find out with the function <code><a href="../reference/draw_blocks.html">draw_blocks()</a></code>, which extracts boundary box data from the <code>.json</code> file and draws numbered rectangles on an image of each page of the source document.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/draw_blocks.html">draw_blocks</a></span><span class="op">(</span><span class="st">"CIA_columns.pdf"</span>, <span class="st">"CIA_columns.json"</span><span class="op">)</span></code></pre></div>
<p>Check your folder for a a file ending in <code>_blocks.png</code> and pull it up:</p>
<p><img src="CIA_columns1_blocks.png" width="50%"></p>
<p>We can immediately see that the blocks are in the wrong order. How to fix this?</p>
<p>Fortunately, the <code>.json</code> file from DAI comes with a ton of data that allow us to programmatically reorder the text. The key is to generate a token dataframe with page location data and then filter and reorder as necessary. We create the dataframe with <code><a href="../reference/build_token_df.html">build_token_df()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_token_df.html">build_token_df</a></span><span class="op">(</span><span class="st">"CIA_columns.json"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">token_df</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    350 obs. of  9 variables:</span>
<span class="co">#&gt;  $ token    : chr  "Approved " "For " "Release " "2009/02/06" ...</span>
<span class="co">#&gt;  $ start_ind: num  1 10 14 22 32 34 37 38 65 72 ...</span>
<span class="co">#&gt;  $ end_ind  : chr  "9" "13" "21" "31" ...</span>
<span class="co">#&gt;  $ left     : num  0.229 0.307 0.338 0.406 0.494 ...</span>
<span class="co">#&gt;  $ right    : num  0.301 0.333 0.397 0.489 0.5 ...</span>
<span class="co">#&gt;  $ top      : num  0.0379 0.0383 0.0383 0.0383 0.0387 ...</span>
<span class="co">#&gt;  $ bottom   : num  0.0546 0.0542 0.0542 0.055 0.0546 ...</span>
<span class="co">#&gt;  $ page     : int  1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ block    : num  1 1 1 1 1 1 1 1 1 2 ...</span></code></pre></div>
<p>The dataframe has the words in the order in which DAI proposes to read them, and the <code>block</code> column has the number of the block to which each word belongs. This allows us to reorder the blocks while keeping the within-block word order intact.</p>
<p>We see from the annotated image that the real order of the blocks should be 1 - 2 - 3 - 5 - 7 - 4 - 6. We can store this in a vector that we use to reorder the dataframe.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span>
<span class="va">token_df</span><span class="op">$</span><span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">token_df</span><span class="op">$</span><span class="va">block</span>, levels <span class="op">=</span> <span class="va">order</span><span class="op">)</span>
<span class="va">token_df_correct</span> <span class="op">&lt;-</span> <span class="va">token_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">token_df</span><span class="op">$</span><span class="va">block</span><span class="op">)</span>,<span class="op">]</span></code></pre></div>
<p>We get the correct text from the <code>token_df_correct$token</code> column:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="va">text</span> <span class="op">&lt;-</span> <span class="va">token_df_correct</span><span class="op">$</span><span class="va">token</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span>collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span></code></pre></div>
<p>Now the transition from the first to the second paragraph makes more sense:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">700</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span>
<span class="co">#&gt; Approved For Release 2009/02/06: CIA-RDP79-00927A006300050002-8</span>
<span class="co">#&gt; SECRET</span>
<span class="co">#&gt; CZECHOSLOVAKIA OUTLINES ECONOMIC "ACTION PROGRAM”</span>
<span class="co">#&gt; The Dubcek regime has out-</span>
<span class="co">#&gt; lined the economic portion of</span>
<span class="co">#&gt; its party "action program.' It</span>
<span class="co">#&gt; calls for the end of fixed prices</span>
<span class="co">#&gt; on a large number of items, with</span>
<span class="co">#&gt; prices on others being permitted</span>
<span class="co">#&gt; to fluctuate within limits. Un-</span>
<span class="co">#&gt; less these changes are made with</span>
<span class="co">#&gt; a careful view to their impact</span>
<span class="co">#&gt; on living standards, however,</span>
<span class="co">#&gt; they might reduce public support</span>
<span class="co">#&gt; for the new Dubcek administra-</span>
<span class="co">#&gt; tion.</span>
<span class="co">#&gt; The Novotny regime had rec-</span>
<span class="co">#&gt; ognized that major changes in</span>
<span class="co">#&gt; the retail pricing system were</span>
<span class="co">#&gt; essential to a meaningful eco-</span>
<span class="co">#&gt; nomic reform program, but had</span>
<span class="co">#&gt; taken little action in this field.</span>
<span class="co">#&gt; Under the</span></code></pre></div>
</div>
<div id="splitting-blocks" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-blocks" class="anchor"></a>Splitting blocks</h2>
<p>A more complex — and, unfortunately, more common — situation is when DAI fails to distinguish between columns. This means that lines do not end where they should, resulting in long stretches of incomprehensible text. We can illustrate this with an article about the great <a href="https://en.wikipedia.org/wiki/Peshtigo_fire">Peshtigo forest fire</a> in Wisconsin in 1871, available on the Internet Archive.</p>
<p><img src="peshtigo.jpg" width="50%"></p>
<p>We do our processing routine again:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="st">"https://archive.org/download/themarinetteandpeshtigoeagleoct141871/The%20Marinette%20and%20Peshtigo%20Eagle%20-%20Oct%2014%201871.pdf"</span>, 
              <span class="st">"peshtigo.pdf"</span>, 
              mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span>
<span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html">gcs_upload</a></span><span class="op">(</span><span class="st">"peshtigo.pdf"</span><span class="op">)</span>
<span class="fu"><a href="../reference/dai_async.html">dai_async</a></span><span class="op">(</span><span class="st">"peshtigo.pdf"</span><span class="op">)</span>
<span class="co"># wait a little</span>

<span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_get_object.html">gcs_get_object</a></span><span class="op">(</span><span class="st">"peshtigo.pdf-output-page-1-to-1.json"</span>, saveToDisk <span class="op">=</span> <span class="st">"peshtigo.json"</span><span class="op">)</span></code></pre></div>
<p>This time we’ll skip the text printout and go straight to inspecting the boundary boxes:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/draw_blocks.html">draw_blocks</a></span><span class="op">(</span><span class="st">"peshtigo.pdf"</span>, <span class="st">"peshtigo.json"</span><span class="op">)</span></code></pre></div>
<p><img src="peshtigo1_blocks.png" width="50%"></p>
<p>As we can see, this time DAI has failed to distinguish between the two main columns. We can verify this by checking the beginning of the text:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/text_from_dai_file.html">text_from_dai_file</a></span><span class="op">(</span><span class="st">"peshtigo.json"</span><span class="op">)</span>
<span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span>
<span class="co">#&gt; The</span>
<span class="co">#&gt; Marinette and</span>
<span class="co">#&gt; Leshtigo Eagle.</span>
<span class="co">#&gt; Vol. I.</span>
<span class="co">#&gt; MARINETTE, WIS, SATURDAY, OCT. 14, 1871.</span>
<span class="co">#&gt; No. 17.</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; ;</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; L. B. NOYES.</span>
<span class="co">#&gt; PUBLISHER. The streets were lined with men, wo-</span>
<span class="co">#&gt; men and children fleeing for their lives.</span>
<span class="co">#&gt; Holocaust of Flame. Many of the families were engaged in</span>
<span class="co">#&gt; making excavations in the sand and bu-</span>
<span class="co">#&gt; PESHTIGO ANNIHILATED : rying their household goods. Any quan-</span>
<span class="co">#&gt; tity of goods wae hauled over on to the</span>
<span class="co">#&gt; 500 LIVES LOST!</span>
<span class="co">#&gt; Island. The sick were being removed to</span>
<span class="co">#&gt; places of safety, and thus, with altern-</span>
<span class="co">#&gt; THE FARMING COUNTRY</span>
<span class="co">#&gt; ate hope and despair, the long, weary</span>
<span class="co">#&gt; hours of the night wore away.</span>
<span class="co">#&gt; RUINED!</span>
<span class="co">#&gt; The wind had at last settled to blow-</span>
<span class="co">#&gt; WHOLE FAMILIES BURNED ing steadily from the south west, but still</span>
<span class="co">#&gt; TO DEATH!!</span>
<span class="co">#&gt; it blew with tremendous fury, and the</span>
<span class="co">#&gt; flames in the swamp immediately in the</span>
<span class="co">#&gt; $2,000,000 worth of Property rear of the town, raged with correspond-</span>
<span class="co">#&gt; Destroyed!!</span>
<span class="co">#&gt; ing fearfulness.</span>
<span class="co">#&gt; MENEKAUNE DESTROYED.</span>
<span class="co">#&gt; Terrible Destruction of Life</span>
<span class="co">#&gt; At daylight we get more definite infor-</span>
<span class="co">#&gt; and Property !--Menekaune</span></code></pre></div>
<p>This means that we must find a way of splitting block 12 vertically.</p>
<p>What we will do is create a new boundary box that captures only the right-hand column. Then we will feed the location coordinates of the new box back into the token dataframe so that the tokens that fall within it are assigned a new block number. We can then reorder the blocks as we did in the previous example.</p>
<p>There are two main ways to obtain the coordinates of a new block: mathematically or through image annotation.</p>
<div id="mathematical-splitting" class="section level3">
<h3 class="hasAnchor">
<a href="#mathematical-splitting" class="anchor"></a>Mathematical splitting</h3>
<p>We can split blocks mathematically by using the location data for existing blocks in the json file. We start by building a block dataframe to keep track of the blocks.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">block_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_block_df.html">build_block_df</a></span><span class="op">(</span><span class="st">"peshtigo.json"</span><span class="op">)</span></code></pre></div>
<p>Then we use the function <code><a href="../reference/split_block.html">split_block()</a></code> to cut block 12 vertically in half. This function takes as input a block dataframe, the page and number of the block to split, and a parameter <code>cut_point</code>, which is a number from 1 to 99 for the relative location of the cut point. <code><a href="../reference/split_block.html">split_block()</a></code> returns a new block dataframe that includes the new block and revised coordinates for the old one.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_block_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/split_block.html">split_block</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">block_df</span>, block <span class="op">=</span> <span class="fl">12</span>, cut_point <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></code></pre></div>
<p>If we had more blocks to split, we could repeat the procedure as many times as necessary. We just have to make sure to feed the latest version of the block dataframe into the <code><a href="../reference/split_block.html">split_block()</a></code> function.</p>
<p>When we have a block dataframe that captures the layout fairly accurately, we can use the <code><a href="../reference/reassign_tokens.html">reassign_tokens()</a></code> function to assign new block values to the words in the <em>token</em> dataframe. <code><a href="../reference/reassign_tokens.html">reassign_tokens()</a></code> takes as input the token dataframe and the new block dataframe and returns a revised token dataframe.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_token_df.html">build_token_df</a></span><span class="op">(</span><span class="st">"peshtigo.json"</span><span class="op">)</span>
<span class="va">token_df_correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reassign_tokens.html">reassign_tokens</a></span><span class="op">(</span><span class="va">token_df</span>, <span class="va">new_block_df</span><span class="op">)</span>  </code></pre></div>
<p>In this particular case, the blocks are in the right order after splitting, so we can extract a correct text right away. In other cases the blocks may need reordering, in which case we use the procedure from the previous section.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">&lt;-</span> <span class="va">token_df_correct</span><span class="op">$</span><span class="va">token</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span>collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span>
<span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span>
<span class="co">#&gt; The</span>
<span class="co">#&gt; Marinette and</span>
<span class="co">#&gt; Leshtigo Eagle.</span>
<span class="co">#&gt; Vol. I.</span>
<span class="co">#&gt; MARINETTE, WIS, SATURDAY, OCT. 14, 1871.</span>
<span class="co">#&gt; No. 17.</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; ;</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; ;</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; :</span>
<span class="co">#&gt; L. B. NOYES.</span>
<span class="co">#&gt; PUBLISHER. Holocaust of Flame. PESHTIGO ANNIHILATED : 500 LIVES LOST!</span>
<span class="co">#&gt; THE FARMING COUNTRY</span>
<span class="co">#&gt; RUINED!</span>
<span class="co">#&gt; WHOLE FAMILIES BURNED TO DEATH!!</span>
<span class="co">#&gt; $2,000,000 worth of Property Destroyed!!</span>
<span class="co">#&gt; Terrible Destruction of Life</span>
<span class="co">#&gt; and Property !--Menekaune Destroyed and Marinette in Great Danger--Buildings in Suburbs Burn--McCartney's Mill Gone--Pioneer </span>
<span class="co">#&gt; Manu-facturing Co.'s Works Des-</span>
<span class="co">#&gt; troyed--Catholic Church &amp; New York Mill destroyed-- Hundreds Starving and Dy-and Dy </span>
<span class="co">#&gt; Ing--1500 people Homeless--</span>
<span class="co">#&gt; Peshtigo Harbor, Marinette</span>
<span class="co">#&gt; Menominee Crowded Fugitives !--We </span>
<span class="co">#&gt; Must have Help--Heart-Rending Details-Noble efforts of the</span>
<span class="co">#&gt; People to Succor the Dis-</span>
<span class="co">#&gt; tressed--Incidents, &amp;c.</span>
<span class="co">#&gt; The streets were lined with men, wo-</span>
<span class="co">#&gt; men and children fleeing for their lives.</span>
<span class="co">#&gt; Many of the families were engaged in</span>
<span class="co">#&gt; making excavations in the sand and bu-</span>
<span class="co">#&gt; rying their household goods. Any quan-</span>
<span class="co">#&gt; tity of goods wae hauled over on to the</span></code></pre></div>
<p>Mathematical splitting will often be the easiest method, and it can be particularly efficient when you have a lot of documents with the exact same column structure. However, it may sometimes be difficult to tell with the naked eye where the cut point should be. At other times the space between columns may be so narrow as to make precision important. For these situations we can use manual image annotation.</p>
</div>
<div id="manual-splitting" class="section level3">
<h3 class="hasAnchor">
<a href="#manual-splitting" class="anchor"></a>Manual splitting</h3>
<p>In principle you can use any image annotation tool, so long as you format the resulting coordinates in a way that <code>daiR</code>’s processing functions understand. In the following, I will use <a href="https://github.com/wkentaro/labelme">labelme</a> because it’s easy to use and <code>daiR</code> has a helper function for it.</p>
<p>Labelme opens from the command line, but has a fairly intuitive graphical user interface. We load the annotated image generated by <code><a href="../reference/draw_blocks.html">draw_blocks()</a></code>, click “create polygons” in the left pane, right-click while the cursor is in the page pane, and choose “create rectangle”.</p>
<p><img src="labelme1.png" width="50%"></p>
<p>Then we mark the right-hand column and label it 13 (for the number of the new block).</p>
<p><img src="labelme2.png" width="50%"></p>
<p>Click “save” and store the json file, for example as <code>peshtigo1_blocks.json</code>. Now we can load it in R and get the coordinates of the new block 13 with the function <code><a href="../reference/from_labelme.html">from_labelme()</a></code>. This function returns a one-row dataframe formatted like block dataframes generated with <code>build_block_df</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">block13</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/from_labelme.html">from_labelme</a></span><span class="op">(</span><span class="st">"peshtigo1_blocks.json"</span><span class="op">)</span></code></pre></div>
<p>We can then assign a new block number to the tokens that fall within block13. For this we use <code><a href="../reference/reassign_tokens2.html">reassign_tokens2()</a></code>, which reassigns tokens on a specified page according to the coordinates of a single new block.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token_df_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reassign_tokens2.html">reassign_tokens2</a></span><span class="op">(</span><span class="va">token_df</span>, <span class="va">block13</span><span class="op">)</span> </code></pre></div>
<p>Now we just need to reorder the token data frame by blocks, and the words will be in the right order. In this particular case, we do not need to supply a custom block order, since the block numbering reflects the right order of the text.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token_df_correct</span> <span class="op">&lt;-</span> <span class="va">token_df_new</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">token_df_new</span><span class="op">$</span><span class="va">block</span><span class="op">)</span>, <span class="op">]</span></code></pre></div>
<p>And again we have a text in the right order.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">&lt;-</span> <span class="va">token_df_correct</span><span class="op">$</span><span class="va">token</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span>collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span>
<span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Thomas Hegghammer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
