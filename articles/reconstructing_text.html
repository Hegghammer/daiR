<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Correcting text output from Google Document AI • daiR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Correcting text output from Google Document AI">
<meta property="og:description" content="daiR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-NL6TR4PT51"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NL6TR4PT51');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">daiR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/basics.html">Quickstart</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setting_up_google_storage.html">Setting up a Google Storage bucket</a>
    </li>
    <li>
      <a href="../articles/using_document_ai.html">Using Google Document AI with R</a>
    </li>
    <li>
      <a href="../articles/extracting_tables.html">Extracting tables</a>
    </li>
    <li>
      <a href="../articles/reconstructing_text.html">Correcting text output from Google Document AI</a>
    </li>
    <li>
      <a href="../articles/complex_file_and_folder_management.html">Complex file and folder management</a>
    </li>
    <li>
      <a href="../articles/searchable_pdfs">Creating searchable PDFs</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/faqs.html">FAQs</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="https://github.com/hegghammer/dair/" class="external-link">
    <span class="fab fa-github"></span>
     
    Github
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Hegghammer/daiR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Correcting text output from Google Document
AI</h1>
                        <h4 data-toc-skip class="author">Thomas
Hegghammer</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Hegghammer/daiR/blob/HEAD/vignettes/reconstructing_text.Rmd" class="external-link"><code>vignettes/reconstructing_text.Rmd</code></a></small>
      <div class="hidden name"><code>reconstructing_text.Rmd</code></div>

    </div>

    
    
<p><strong>Last updated 4 April 2021</strong><br><br><br></p>
<p>Google Document AI (DAI) has excellent character recognition, but
often reads columns wrong. This vignette will show you how to identify
and reorder jumbled text with the tools in the <code>daiR</code>
package.</p>
<div class="section level2">
<h2 id="the-problem">The problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>Server-based OCR engines such as Google Document AI and Amazon
Textract represent a major advance in OCR technology. They handle visual
noise extremely well and effectively eliminate the need for image
preprocessing, the most agonizing part of OCR in <code>tesseract</code>
and other standalone libraries. DAI also reads non-Western languages
such as Arabic better than any other general engine I have seen.</p>
<p>But DAI and Textract still struggle with text columns and irregular
page layouts. In my experience, DAI will misread a multi-column page
about half the time, and the error rate increases with the complexity of
the layout. This is not a problem if you plan to apply “bag-of-words”
text mining techniques, but if you’re looking at Natural Language
Processing or actually reading the text, you cannot trust Document AI or
Textract to always return accurate text.</p>
<p>DAI column-reading errors are of two main types. The first is to put
text blocks in the wrong order, and the second is to merge blocks that
shouldn’t be merged. Both errors can be corrected programmatically with
the tools in the <code>daiR</code> package.</p>
</div>
<div class="section level2">
<h2 id="reordering-blocks">Reordering blocks<a class="anchor" aria-label="anchor" href="#reordering-blocks"></a>
</h2>
<p>To illustrate, let’s feed DAI a simple two-column text. This one is
from the CIA’s archive of declassified intelligence documents:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://www.cia.gov/readingroom/docs/1968-03-08.pdf"</span>, </span>
<span>              destfile <span class="op">=</span> <span class="st">"CIA_columns.pdf"</span>, </span>
<span>              mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CIA_columns.jpg" width="50%"></p>
<p>We start by uploading it to Google Storage and passing it to Document
AI.</p>
<pre><code><span><span class="co">#&gt; Welcome to daiR 0.9.9, your gateway to Google Document AI v1.</span></span>
<span><span class="co">#&gt; Access token available.</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Hegghammer/daiR" class="external-link">daiR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/" class="external-link">googleCloudStorageR</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html" class="external-link">gcs_upload</a></span><span class="op">(</span><span class="st">"CIA_columns.pdf"</span><span class="op">)</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dai_async.html">dai_async</a></span><span class="op">(</span><span class="st">"CIA_columns.pdf"</span><span class="op">)</span></span></code></pre></div>
<p>Note that this code assumes you have set <code>GCS_AUTH_FILE</code>
and <code>GCS_DEFAULT_BUCKET</code> variables in your .Renviron file
(see the <a href="https://dair.info/articles/setting_up_google_storage.html" class="external-link">two</a>
<a href="https://dair.info/articles/using_document_ai.html" class="external-link">previous</a>
vignettes for details).</p>
<p>We check our bucket for the json output and download it when it’s
ready:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_list_objects.html" class="external-link">gcs_list_objects</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## NOT RUN</span></span>
<span><span class="va">our_file</span> <span class="op">&lt;-</span> <span class="st">"&lt;job_number&gt;/0/CIA_columns-0.json"</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_get_object.html" class="external-link">gcs_get_object</a></span><span class="op">(</span><span class="va">our_file</span>, saveToDisk <span class="op">=</span> <span class="st">"CIA_columns.json"</span><span class="op">)</span></span></code></pre></div>
<p>Finally we extract the text:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/text_from_dai_file.html">text_from_dai_file</a></span><span class="op">(</span><span class="st">"CIA_columns.json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span></span></code></pre></div>
<p>On first inspection, this does not look so bad. But notice the
transition from the first to the second paragraph:</p>
<blockquote>
<p>… they might reduce public support for the new Dubcek administration.
Czech consumer in connection with these price increases.</p>
</blockquote>
<p>Something’s not right. Could it be a column-reading error?</p>
<p>We can find out with the function <code><a href="../reference/draw_blocks.html">draw_blocks()</a></code>, which
extracts boundary box data from the <code>.json</code> file and draws
numbered rectangles on an image of each page of the source document.
(The images come from the json file, where they are stored as
base64-encoded strings.)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/draw_blocks.html">draw_blocks</a></span><span class="op">(</span><span class="va">dest_path2</span>, dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Check your temporary directory (type <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code> for the
path) for a file ending in <code>_blocks.png</code> and pull it up:</p>
<p><img src="CIA_columns1_blocks.png" width="50%"></p>
<p>We can immediately see that the blocks are in the wrong order. How to
fix this?</p>
<p>Fortunately, the <code>.json</code> file from DAI comes with a ton of
data that allow us to programmatically reorder the text. The key is to
generate a token dataframe with page location data and then filter and
reorder as necessary. We create the dataframe with
<code><a href="../reference/build_token_df.html">build_token_df()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_token_df.html">build_token_df</a></span><span class="op">(</span><span class="va">dest_path2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">token_df</span><span class="op">)</span></span></code></pre></div>
<p>The dataframe has the words in the order in which DAI proposes to
read them, and the <code>block</code> column has the number of the block
to which each word belongs. This allows us to reorder the blocks while
keeping the within-block word order intact.</p>
<p>We see from the annotated image that the real order of the blocks
should be 1 - 2 - 3 - 5 - 7 - 4 - 6. We can store this in a vector that
we use to reorder the dataframe.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">token_df</span><span class="op">$</span><span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">token_df</span><span class="op">$</span><span class="va">block</span>, levels <span class="op">=</span> <span class="va">order</span><span class="op">)</span></span>
<span><span class="va">token_df_correct</span> <span class="op">&lt;-</span> <span class="va">token_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">token_df</span><span class="op">$</span><span class="va">block</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>We get the correct text from the <code>token_df_correct$token</code>
column:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">text</span> <span class="op">&lt;-</span> <span class="va">token_df_correct</span><span class="op">$</span><span class="va">token</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p>Now the transition from the first to the second paragraph makes more
sense:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">700</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="splitting-blocks">Splitting blocks<a class="anchor" aria-label="anchor" href="#splitting-blocks"></a>
</h2>
<p>A more complex — and, unfortunately, more common — situation is when
DAI fails to distinguish between columns. This means that lines do not
end where they should, resulting in long stretches of incomprehensible
text. We can illustrate this with an article about the great <a href="https://en.wikipedia.org/wiki/Peshtigo_fire" class="external-link">Peshtigo forest
fire</a> in Wisconsin in 1871, available on the Internet Archive.</p>
<p><img src="peshtigo.jpg" width="50%"></p>
<p>We do our processing routine again:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://archive.org/download/themarinetteandpeshtigoeagleoct141871/The%20Marinette%20and%20Peshtigo%20Eagle%20-%20Oct%2014%201871.pdf"</span>, </span>
<span>              destfile <span class="op">=</span> <span class="st">"peshtigo.pdf"</span>, </span>
<span>              mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html" class="external-link">gcs_upload</a></span><span class="op">(</span><span class="st">"peshtigo.pdf"</span><span class="op">)</span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dai_async.html">dai_async</a></span><span class="op">(</span><span class="st">"peshtigo.pdf"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># wait till ready</span></span>
<span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_list_objects.html" class="external-link">gcs_list_objects</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## NOT RUN</span></span>
<span><span class="va">our_file</span> <span class="op">&lt;-</span> <span class="st">"&lt;job_number&gt;/0/peshtigo-0.json"</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_get_object.html" class="external-link">gcs_get_object</a></span><span class="op">(</span><span class="va">our_file</span>, saveToDisk <span class="op">=</span> <span class="st">"peshtigo.json"</span><span class="op">)</span></span></code></pre></div>
<p>This time we’ll skip the text printout and go straight to inspecting
the boundary boxes:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/draw_blocks.html">draw_blocks</a></span><span class="op">(</span><span class="st">"peshtigo.json"</span>, dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="peshtigo1_blocks.png" width="50%"></p>
<p>As we can see, this time DAI has failed to distinguish between the
two main columns. We can verify this by checking the beginning of the
text:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/text_from_dai_file.html">text_from_dai_file</a></span><span class="op">(</span><span class="st">"peshtigo.json"</span><span class="op">)</span></span>
<span><span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span></span></code></pre></div>
<p>This means that we must find a way of splitting block 12
vertically.</p>
<p>What we will do is create a new boundary box that captures only the
right-hand column. Then we will feed the location coordinates of the new
box back into the token dataframe so that the tokens that fall within it
are assigned a new block number. We can then reorder the blocks as we
did in the previous example.</p>
<p>There are two main ways to obtain the coordinates of a new block:
mathematically or through image annotation.</p>
<div class="section level3">
<h3 id="mathematical-splitting">Mathematical splitting<a class="anchor" aria-label="anchor" href="#mathematical-splitting"></a>
</h3>
<p>We can split blocks mathematically by using the location data for
existing blocks in the json file. We start by building a block dataframe
to keep track of the blocks.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_block_df.html">build_block_df</a></span><span class="op">(</span><span class="va">dest_path4</span><span class="op">)</span></span></code></pre></div>
<p>Then we use the function <code><a href="../reference/split_block.html">split_block()</a></code> to cut block 12
vertically in half. This function takes as input a block dataframe, the
page and number of the block to split, and a parameter
<code>cut_point</code>, which is a number from 1 to 99 for the relative
location of the cut point. <code><a href="../reference/split_block.html">split_block()</a></code> returns a new
block dataframe that includes the new block and revised coordinates for
the old one.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_block_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/split_block.html">split_block</a></span><span class="op">(</span><span class="va">block_df</span>, block <span class="op">=</span> <span class="fl">12</span>, cut_point <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>If we had more blocks to split, we could repeat the procedure as many
times as necessary. We just have to make sure to feed the latest version
of the block dataframe into the <code><a href="../reference/split_block.html">split_block()</a></code> function.</p>
<p>When we have a block dataframe that captures the layout fairly
accurately, we can use the <code><a href="../reference/reassign_tokens.html">reassign_tokens()</a></code> function to
assign new block values to the words in the <em>token</em> dataframe.
<code><a href="../reference/reassign_tokens.html">reassign_tokens()</a></code> takes as input the token dataframe and
the new block dataframe and returns a revised token dataframe.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_token_df.html">build_token_df</a></span><span class="op">(</span><span class="va">dest_path4</span><span class="op">)</span></span>
<span><span class="va">token_df_correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reassign_tokens.html">reassign_tokens</a></span><span class="op">(</span><span class="va">token_df</span>, <span class="va">new_block_df</span><span class="op">)</span>  </span></code></pre></div>
<p>In this particular case, the blocks are in the right order after
splitting, so we can extract a correct text right away. In other cases
the blocks may need reordering, in which case we use the procedure from
the previous section.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text</span> <span class="op">&lt;-</span> <span class="va">token_df_correct</span><span class="op">$</span><span class="va">token</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span></span></code></pre></div>
<p>Mathematical splitting will often be the easiest method, and it can
be particularly efficient when you have a lot of documents with the
exact same column structure. However, it may sometimes be difficult to
tell with the naked eye where the cut point should be. At other times
the space between columns may be so narrow as to make precision
important. For these situations we can use manual image annotation.</p>
</div>
<div class="section level3">
<h3 id="manual-splitting">Manual splitting<a class="anchor" aria-label="anchor" href="#manual-splitting"></a>
</h3>
<p>In principle you can use any image annotation tool, so long as you
format the resulting coordinates in a way that <code>daiR</code>’s
processing functions understand. In the following, I will use <a href="https://github.com/wkentaro/labelme" class="external-link">labelme</a> because it’s easy
to use and <code>daiR</code> has a helper function for it.</p>
<p>Labelme opens from the command line, but has a fairly intuitive
graphical user interface. We load the annotated image generated by
<code><a href="../reference/draw_blocks.html">draw_blocks()</a></code>, click “create polygons” in the left pane,
right-click while the cursor is in the page pane, and choose “create
rectangle”.</p>
<p><img src="labelme1.png" width="50%"></p>
<p>Then we mark the right-hand column and label it 13 (for the number of
the new block).</p>
<p><img src="labelme2.png" width="50%"></p>
<p>Click “save” and store the json file, for example as
<code>peshtigo1_blocks.json</code>. Now we can load it in R and get the
coordinates of the new block 13 with the function
<code><a href="../reference/from_labelme.html">from_labelme()</a></code>. This function returns a one-row dataframe
formatted like block dataframes generated with
<code>build_block_df</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block13</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/from_labelme.html">from_labelme</a></span><span class="op">(</span><span class="st">"peshtigo1_blocks.json"</span><span class="op">)</span></span></code></pre></div>
<p>We can then assign a new block number to the tokens that fall within
block13. For this we use <code><a href="../reference/reassign_tokens2.html">reassign_tokens2()</a></code>, which
reassigns tokens on a specified page according to the coordinates of a
single new block.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token_df_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reassign_tokens2.html">reassign_tokens2</a></span><span class="op">(</span><span class="va">token_df</span>, <span class="va">block13</span><span class="op">)</span> </span></code></pre></div>
<p>Now we just need to reorder the token data frame by blocks, and the
words will be in the right order. In this particular case, we do not
need to supply a custom block order, since the block numbering reflects
the right order of the text.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">token_df_correct</span> <span class="op">&lt;-</span> <span class="va">token_df_new</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">token_df_new</span><span class="op">$</span><span class="va">block</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p>And again we have a text in the right order.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">text</span> <span class="op">&lt;-</span> <span class="va">token_df_correct</span><span class="op">$</span><span class="va">token</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">snippet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">text</span>, start <span class="op">=</span> <span class="fl">1</span>, stop <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">snippet</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Thomas Hegghammer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
